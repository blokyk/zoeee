# A quick guide on debugging NixOS modules (on non-NixOS systems!)

<details>
<summary>
This post is intended for readers already familiar with Nix and NixOS
</summary>

If you have no idea what those words mean, I'd recommend you
[try to](https://thegrayarea.tech/why-do-people-love-nixos-so-much-a60c363b2b94)
[look into it](https://pierrezemb.fr/posts/nixos-good-bad-ugly/),
if you can navigate the badly-written guides and DevOps-poisoned buzzwords
thrown around sometimes. It's something I'm really passionate about these days
(and I feel like most of the docs/posts/guides on it don't match my experience,
are aimed at non-average users, or needlessly complicate things, so I might
write a post about it one day!)

</details>

## Context

I run NixOS on my server, and maintain my own tiny collection of modules and
packages in [blokyk/packages.nix](https://github.com/blokyk/packages.nix/). I
then just use this repo as a channel on my server, so that it's properly
"integrated" into my config and I don't have to think too hard about hashes or
whatever (after all, I control that repo, so...). It encourages me to write
modules in a more *modular* way, and also makes the fruits of my labor more
easily reusable by others.

## The problem

There is just one problem with this setup: I develop those modules on my
laptop which runs... Ubuntu. Thus, I can't easily check or debug my code, and
instead have to do a bunch of tiny wip commits and then constant re-run
`nix-channel --upgrade` on my server, and boy howdy  that get tiring **very**
fast. For a moment, I considered just giving up on local editing and just doing
everything on my server.

Basically, I want to know if this...

```nix
{ lib, pkgs, ... }: {
  services.foo = {
    options = {
      enable = mkEnableOption "foo";
    };

    config = {
      environment.systemPackages = [ pkgs.hello ];
    };
  };
}
```

...is a valid module, and that when like this on NixOS...

```nix
{ ... }: {
  imports = [ ./foo.nix ];
  services.foo.enable = true;
}
```

...it does exactly what I expect:

```sh
nix-test% hello
Hello, world!

```

And I want to figure that out *without* having to replace my whole OS with
NixOS.

## A light in the dark

Our first guest on today's show is `<nixpkgs/nixos>.vm`.

If you've ever used or heard of `nixos-rebuild build-vm`, this is basically
what it does internally. However, `nixos-rebuild` isn't available on non-NixOS
installations, so we'll have to do a few things manually.

### 1. Get a basic

Obviously, to test if our module works in a given config, we'll need a config
to give. Depending on your use-case, this can be your own normal config (mine
is [on github](https://github.com/blokyk/naqi.nix) so it's easy to get), but
it can also be a very minimal config that only includes what you absolutely
need, since, by default, `vm` configs already configures some virtual hardware
and networking aspects. So you could literally just use:

```nix[configuration.nix]
```

// notes:
//   https://notashelf.dev/posts/nixos-testing-i
//   https://github.com/foundationdb-rs/overlay/blob/main/tests/cluster.nix
//   https://jeancharles.quillet.org/posts/2023-01-16-Basic-nix-vm-for-just-anything.html